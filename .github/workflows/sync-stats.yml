name: Sync Statistics

on:
  schedule:
    # Run daily at midnight UTC
    - cron: '0 0 * * *'
  workflow_dispatch:  # Allows manual trigger from Actions tab

jobs:
  collect-stats:
    runs-on: ubuntu-latest
    
    steps:
      - name: Collect traffic data
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          STATS_PAT: ${{ secrets.STATS_PAT }}
          REPO_OWNER: ${{ github.repository_owner }}
          REPO_NAME: ${{ github.event.repository.name }}
          STATS_REPO: ${{ secrets.STATS_REPO }}  # e.g., "username/repo-stats"
        run: |
          python3 << 'EOF'
          import urllib.request
          import json
          import os
          from datetime import datetime, timezone
          
          # Get repository info from environment
          owner = os.environ['REPO_OWNER']
          repo = os.environ['REPO_NAME']
          token = os.environ['STATS_PAT']
          
          # Endpoints to collect
          endpoints = [
              f'https://api.github.com/repos/{owner}/{repo}/traffic/clones',
              f'https://api.github.com/repos/{owner}/{repo}/traffic/views',
              f'https://api.github.com/repos/{owner}/{repo}/traffic/popular/referrers',
              f'https://api.github.com/repos/{owner}/{repo}/traffic/popular/paths'
          ]
          
          timestamp = datetime.now(timezone.utc).isoformat()
                    
          # Collect data from each endpoint
          all_data = {'timestamp': timestamp, 'repository': f'{owner}/{repo}'}
          
          for endpoint in endpoints:
              req = urllib.request.Request(endpoint)
              req.add_header('Authorization', f'token {token}')
              req.add_header('Accept', 'application/vnd.github.v3+json')
              
              try:
                  with urllib.request.urlopen(req) as response:
                      endpoint_data = json.loads(response.read().decode())
                      endpoint_name = endpoint.split('/')[-1]
                      all_data[endpoint_name] = endpoint_data
              except Exception as e:
                  print(f"Error fetching {endpoint}: {e}")
          
          # Save to temporary file
          date_str = datetime.now(timezone.utc).strftime('%Y-%m-%d')
          os.makedirs('temp_data', exist_ok=True)
          filename = f'temp_data/{repo}_{date_str}.json'
          
          with open(filename, 'w') as f:
              json.dump(all_data, f, indent=2)
          
          print(f"Saved traffic data to {filename}")
          print(json.dumps(all_data, indent=2))
          
          EOF
      
      - name: Clone stats repository
        env:
          STATS_PAT: ${{ secrets.STATS_PAT }}
          STATS_REPO: ${{ secrets.STATS_REPO }}
        run: |
          git clone https://x-access-token:$STATS_PAT@github.com/$STATS_REPO.git stats-repo
      
      - name: Copy data to stats repository
        env:
          REPO_NAME: ${{ github.event.repository.name }}
        run: |
          # Create directory for this repository if it doesn't exist
          mkdir -p stats-repo/$REPO_NAME
          
          # Copy the collected data
          cp -r temp_data/* stats-repo/$REPO_NAME/
          
          # Update summary file
          cd stats-repo/$REPO_NAME
          
          # Create or update summary
          python3 << 'EOF'
          import json
          import os
          from datetime import datetime
          from glob import glob
          
          summary = {'repository': os.environ['REPO_NAME'], 'daily_snapshots': []}
          
          # Read all JSON files
          for json_file in sorted(glob('*.json')):
              if json_file == 'summary.json':
                  continue
              
              with open(json_file, 'r') as f:
                  data = json.load(f)
              
              date = json_file.replace(f"{os.environ['REPO_NAME']}_", '').replace('.json', '')
              summary['daily_snapshots'].append({
                  'date': date,
                  'clones_total': data.get('clones', {}).get('count', 0),
                  'clones_unique': data.get('clones', {}).get('uniques', 0),
                  'views_total': data.get('views', {}).get('count', 0),
                  'views_unique': data.get('views', {}).get('uniques', 0)
              })
          
          with open('summary.json', 'w') as f:
              json.dump(summary, f, indent=2)
          
          print(f"Updated summary with {len(summary['daily_snapshots'])} entries")
          EOF
      
      - name: Commit and push to stats repository
        env:
          REPO_NAME: ${{ github.event.repository.name }}
        run: |
          cd stats-repo
          git config user.name "GitHub Actions Bot"
          git config user.email "actions@github.com"
          git add .
          git diff --staged --quiet || git commit -m "Traffic data for $REPO_NAME - $(date -u +%Y-%m-%d)"
          git push
